# Template API Reference

This document provides a complete reference of all variables and methods available in Simpla templates.

---

## Table of Contents

1. [Overview](#overview)
2. [Global Variables](#global-variables)
3. [Template-Specific Variables](#template-specific-variables)
4. [Entity API](#entity-api)
5. [Config Object Reference](#config-object-reference)
6. [Menu System API](#menu-system-api)
7. [Helper Patterns](#helper-patterns)

---

## Overview

Simpla templates are PHP files (`.phtml`) that receive variables via `extract()`. Each template type receives different variables depending on its context.

### Template Types

| Template | Purpose | Key Variables |
|----------|---------|---------------|
| `page.phtml` | Single static page | `$entity`, `$config`, `$generatedMenus` |
| `post.phtml` | Single blog post | `$entity`, `$config`, `$generatedMenus` |
| `index.phtml` | Blog post list | `$entities`, `$config`, `$generatedMenus`, `$slug`, `$displayExcerpt` |
| `tag.phtml` | Tag archive | `$entities`, `$config`, `$generatedMenus`, `$slug`, `$snippet` |
| `homepage.phtml` | Custom homepage | `$entity`, `$config`, `$generatedMenus` |
| `menus/*.phtml` | Navigation menus | `$menuItems`, `$buildMenuLink`, `$config` |
| `partials/*.phtml` | Reusable parts | Inherited from parent template |

---

## Global Variables

These variables are available in **all layout templates** (not partials, which inherit from their parent).

### `$config` (object)

The site configuration object. Contains all settings from `config/config.php`.

```php
// Access any config value
<?= $config->title ?>              // "My Website"
<?= $config->tagline ?>            // "A blog about code"
<?= $config->base_url ?>           // "https://example.com"
<?= $config->language ?>           // "en-US"
<?= $config->author ?>             // "John Doe"
<?= $config->description ?>        // "Site description..."
<?= $config->theme ?>              // "default"
<?= $config->tag_path ?>           // "tags"
<?= $config->file_extension_content ?>  // "html"
<?= $config->file_extension_feed ?>     // "xml"

// Nested objects
<?= $config->slugs->post_index ?>  // "blog"
<?= $config->slugs->feed ?>        // "feed"
<?= $config->folders->dist ?>      // Absolute path to dist folder
<?= $config->folders->views ?>     // Absolute path to views folder
```

### `$generatedMenus` (array)

Pre-rendered HTML for each menu defined in config. Keys match menu names.

```php
// Output a menu
<?= $generatedMenus['main'] ?>     // Rendered main navigation
<?= $generatedMenus['footer'] ?>   // Rendered footer links
<?= $generatedMenus['social'] ?>   // Rendered social links

// Check if menu exists
<?php if (isset($generatedMenus['sidebar'])): ?>
    <?= $generatedMenus['sidebar'] ?>
<?php endif; ?>
```

---

## Template-Specific Variables

### Single Content Templates (`page.phtml`, `post.phtml`)

#### `$entity` (Entity object)

The current page or post being rendered.

```php
// Basic properties
<?= $entity->get('title') ?>           // "My Post Title"
<?= $entity->get('content') ?>         // "<p>Rendered HTML content...</p>"
<?= $entity->get('status') ?>          // "published" or "draft"
<?= $entity->get('author') ?>          // "Jane Doe" or null
<?= $entity->get('description') ?>     // "Meta description" or null
<?= $entity->get('image') ?>           // "photo.jpg" or null
<?= $entity->get('template') ?>        // "custom.phtml" or null
<?= $entity->get('slug') ?>            // "custom-slug" or null

// DateTime object
<?= $entity->get('created_at')->format('Y-m-d') ?>     // "2025-01-02"
<?= $entity->get('created_at')->format('F j, Y') ?>    // "January 2, 2025"
<?= $entity->get('created_at')->getTimestamp() ?>      // Unix timestamp

// URL generation
<?= $entity->getSlug() ?>                      // "/my-post-title"
<?= $entity->getSlug($config->base_url) ?>     // "https://example.com/my-post-title"

// Posts only: tags
<?php foreach ($entity->get('tags') ?? [] as $tag): ?>
    <a href="/<?= $config->tag_path ?>/<?= strtolower($tag) ?>.html"><?= $tag ?></a>
<?php endforeach; ?>

// Posts only: excerpt
<?= $entity->getExcerpt() ?>  // First 3 paragraphs of content
```

### Index Templates (`index.phtml`)

#### `$entities` (array)

Array of Post entity objects, sorted by `created_at` descending (newest first).

```php
<?php foreach ($entities as $entity): ?>
    <article>
        <h2><?= $entity->get('title') ?></h2>
        <time><?= $entity->get('created_at')->format('Y-m-d') ?></time>
        <?= $entity->getExcerpt() ?>
    </article>
<?php endforeach; ?>

// Check if empty
<?php if (empty($entities)): ?>
    <p>No posts yet.</p>
<?php endif; ?>

// Count posts
<p>Showing <?= count($entities) ?> posts</p>
```

#### `$slug` (string)

The slug/filename for the current index page (without extension).

```php
<?= $slug ?>  // "blog" or "index"
```

#### `$displayExcerpt` (bool)

Always `true` in index templates. Use to conditionally show excerpts vs full content.

```php
<?php if ($displayExcerpt): ?>
    <?= $entity->getExcerpt() ?>
    <a href="<?= $entity->getSlug($config->base_url) ?>.html">Read more</a>
<?php else: ?>
    <?= $entity->get('content') ?>
<?php endif; ?>
```

### Tag Templates (`tag.phtml`)

Inherits all variables from index templates, plus:

#### `$snippet` (Entity|null)

Optional Snippet entity for tag description. `null` if no snippet exists for this tag.

```php
<?php if ($snippet !== null): ?>
    <div class="tag-description">
        <?= $snippet->get('content') ?>
    </div>
<?php endif; ?>
```

#### `$slug` (string)

The tag name (lowercase, hyphenated).

```php
<h1>Posts tagged: <?= ucwords(str_replace('-', ' ', $slug)) ?></h1>
// "Posts tagged: Static Websites"
```

---

## Entity API

### Entity Types

| Type | Class | Created From |
|------|-------|--------------|
| Page | `Simpla\Entity\Page` | `content/pages/*.md` |
| Post | `Simpla\Entity\Post` | `content/posts/*.md` |
| Snippet | `Simpla\Entity\Snippet` | `content/snippets/*.md` |

### Common Methods

All entity types share these methods:

#### `get(string $key): mixed`

Get any frontmatter value or computed property.

```php
$entity->get('title')       // string: Always present
$entity->get('status')      // string: 'published' or 'draft'
$entity->get('created_at')  // DateTime: Publication date
$entity->get('content')     // string: Rendered HTML content
$entity->get('author')      // string|null: Author name
$entity->get('description') // string|null: Meta description
$entity->get('slug')        // string|null: Custom URL slug
$entity->get('template')    // string|null: Custom template filename
$entity->get('image')       // string|null: Featured image filename
$entity->get('nonexistent') // null: Unknown keys return null
```

#### `getSlug(string $baseURL = ''): string`

Generate the URL path for this entity.

```php
// Without base URL (relative)
$entity->getSlug()
// Returns: "/my-post-title"

// With base URL (absolute)
$entity->getSlug('https://example.com')
// Returns: "https://example.com/my-post-title"

// Slug generation rules:
// 1. Uses 'slug' frontmatter if set
// 2. Otherwise, uses 'title'
// 3. Converts to lowercase
// 4. Replaces non-alphanumeric chars with hyphens
// 5. Trims leading/trailing hyphens
```

### Post-Specific Methods

#### `getExcerpt(): string`

Returns the first 3 paragraphs of content, or full content if shorter.

```php
$post->getExcerpt()
// Returns: "<p>First paragraph...</p><p>Second...</p><p>Third...</p>"

// Full content is returned if:
// - Content has fewer than 150 words total
// - Content has 3 or fewer paragraphs
```

### Post-Specific Properties

#### `tags` (array|null)

Array of tag names (trimmed strings).

```php
$entity->get('tags')
// Returns: ['javascript', 'tutorial', 'beginner']
// Or: null if no tags

// From frontmatter: "tags: javascript, tutorial, beginner"
```

---

## Config Object Reference

The `$config` object contains all settings from `config/config.php`. Here's the complete structure:

### Top-Level Properties

```php
$config->theme                    // string: Theme folder name
$config->base_url                 // string: Site URL (may be empty)
$config->title                    // string: Site title
$config->tagline                  // string: Site tagline
$config->description              // string: Site description
$config->language                 // string: HTML lang code
$config->author                   // string: Default author
$config->tag_path                 // string: Tag URL prefix
$config->file_extension_content   // string: "html"
$config->file_extension_feed      // string: "xml"
```

### Nested Objects

#### `$config->slugs`

```php
$config->slugs->post_index   // string: Blog index filename
$config->slugs->feed         // string: RSS feed filename
```

#### `$config->folders`

```php
$config->folders->assets              // string: "assets"
$config->folders->dist                // string: Absolute path to dist/
$config->folders->dist_tags           // string: Absolute path to dist/tags/
$config->folders->content_images      // string: Absolute path to content/img/
$config->folders->dist_content_images // string: Absolute path to dist/img/
$config->folders->views               // string: Absolute path to views/
$config->folders->content             // string: Absolute path to content/
```

#### `$config->images`

```php
$config->images->max_width      // int|null: resize width cap (null to disable)
$config->images->max_height     // int|null: resize height cap (null to disable)
$config->images->generate_webp  // bool: also emit .webp next to originals
$config->images->webp_quality   // int: 0-100
$config->images->jpeg_quality   // int: 0-100
$config->images->png_compression// int: 0-9
$config->images->lazy           // bool: add loading="lazy" to Markdown images
```

#### `$config->views`

```php
$config->views->post         // string: "post.phtml"
$config->views->post_index   // string: "index.phtml"
$config->views->page         // string: "page.phtml"
$config->views->tag          // string: "tag.phtml"
$config->views->menus->main  // string: "menus/main.phtml"
// etc.
```

#### `$config->content`

```php
$config->content->posts      // string: "posts"
$config->content->pages      // string: "pages"
$config->content->snippets   // string: "snippets"
```

#### `$config->menus`

Access raw menu definitions (usually use `$generatedMenus` instead):

```php
$config->menus->main    // array of menu item objects
$config->menus->footer  // array of menu item objects
$config->menus->social  // array of menu item objects
```

### Custom Properties

Any custom keys added to `config.php` are available:

```php
// In config.php:
"analytics_id" => "UA-12345",
"show_author" => true,

// In templates:
<?= $config->analytics_id ?>    // "UA-12345"
<?= $config->show_author ?>     // true
```

---

## Menu System API

Menu templates receive special variables for rendering navigation.

### Menu Template Variables

#### `$menuItems` (array)

Array of menu item objects as defined in config.

```php
<?php foreach ($menuItems as $item): ?>
    <?php var_dump($item); ?>
    // object(stdClass) {
    //   ["internal"] => "about"  // or ["external"] => "https://..."
    //   ["label"] => "About"
    //   ["type"] => "content"    // optional: "content" or "feed"
    // }
<?php endforeach; ?>
```

#### `$buildMenuLink(object $item): string`

Helper function to generate an `<a>` tag with proper href.

```php
<?php foreach ($menuItems as $item): ?>
    <?= $buildMenuLink($item) ?>
    // Output: <a href="https://example.com/about.html">About</a>
<?php endforeach; ?>
```

#### `$config` (object)

Full config object (same as in other templates).

### Menu Item Properties

| Property | Type | Description |
|----------|------|-------------|
| `internal` | string | Internal page slug (mutually exclusive with `external`) |
| `external` | string | External URL (mutually exclusive with `internal`) |
| `label` | string | Display text |
| `type` | string | Optional: `"content"` (default) or `"feed"` |

### Custom Menu Rendering

For full control, render menus manually:

```php
<nav>
    <?php foreach ($menuItems as $item): ?>
        <?php
        // Determine URL
        if (isset($item->external)) {
            $href = $item->external;
            $isExternal = true;
        } else {
            $extension = ($item->type ?? 'content') === 'feed'
                ? $config->file_extension_feed
                : $config->file_extension_content;
            $href = $config->base_url . '/' . $item->internal . '.' . $extension;
            $isExternal = false;
        }
        ?>
        <a href="<?= $href ?>"
           <?= $isExternal ? 'target="_blank" rel="noopener noreferrer"' : '' ?>>
            <?= htmlspecialchars($item->label) ?>
            <?= $isExternal ? '↗' : '' ?>
        </a>
    <?php endforeach; ?>
</nav>
```

---

## Helper Patterns

### Conditional Author Display

```php
<?php
$author = $entity->get('author') ?? $config->author;
?>
<span class="author">by <?= htmlspecialchars($author) ?></span>
```

### Safe Image Display

```php
<?php if ($image = $entity->get('image')): ?>
    <img src="<?= $config->base_url ?>/img/<?= htmlspecialchars($image) ?>"
         alt="<?= htmlspecialchars($entity->get('title')) ?>"
         loading="lazy">
<?php endif; ?>
```

> **Tip:** Markdown images get `loading="lazy"` by default. For preferred WebP delivery, you can create a picture tag in Markdown:
> 
> `![Alt](/img/foo.jpg){picture webp="/img/foo.webp"}`

### Full URL Generation

```php
<?php
$fullUrl = $entity->getSlug($config->base_url) . '.' . $config->file_extension_content;
// "https://example.com/my-post.html"
?>
<link rel="canonical" href="<?= $fullUrl ?>">
```

### Tag List with Separators

```php
<?php if ($tags = $entity->get('tags')): ?>
    <div class="tags">
        <?php foreach ($tags as $i => $tag): ?>
            <a href="<?= $config->base_url ?>/<?= $config->tag_path ?>/<?= strtolower($tag) ?>.<?= $config->file_extension_content ?>">
                <?= htmlspecialchars($tag) ?>
            </a><?= $i < count($tags) - 1 ? ', ' : '' ?>
        <?php endforeach; ?>
    </div>
<?php endif; ?>
```

### Date Formatting Examples

```php
<?php $date = $entity->get('created_at'); ?>

<?= $date->format('Y-m-d') ?>           // 2025-01-02
<?= $date->format('F j, Y') ?>          // January 2, 2025
<?= $date->format('M j') ?>             // Jan 2
<?= $date->format('l, F j, Y') ?>       // Thursday, January 2, 2025
<?= $date->format('c') ?>               // 2025-01-02T00:00:00+00:00 (ISO 8601)

<!-- HTML5 time element -->
<time datetime="<?= $date->format('Y-m-d') ?>">
    <?= $date->format('F j, Y') ?>
</time>
```

### Including Partials with Variables

Partials inherit all variables from the parent template scope:

```php
<!-- In index.phtml -->
<?php
$displayExcerpt = true;
foreach ($entities as $entity):
    include __DIR__ . '/partials/article.phtml';
endforeach;
?>
```

```php
<!-- In partials/article.phtml -->
<!-- $entity, $config, $displayExcerpt are all available -->
<article>
    <h2><?= $entity->get('title') ?></h2>
    <?= $displayExcerpt ? $entity->getExcerpt() : $entity->get('content') ?>
</article>
```

### Checking Entity Type

```php
<?php
// Check if entity is a Post (has getExcerpt method)
$isPost = method_exists($entity, 'getExcerpt');

// Or check for tags (only Posts have tags)
$isPost = $entity->get('tags') !== null;
?>
```

---

## Quick Reference Card

### Variables by Template

| Variable | page | post | index | tag | menu |
|----------|:----:|:----:|:-----:|:---:|:----:|
| `$config` | ✓ | ✓ | ✓ | ✓ | ✓ |
| `$generatedMenus` | ✓ | ✓ | ✓ | ✓ | – |
| `$entity` | ✓ | ✓ | – | – | – |
| `$entities` | – | – | ✓ | ✓ | – |
| `$slug` | – | – | ✓ | ✓ | – |
| `$displayExcerpt` | – | – | ✓ | – | – |
| `$snippet` | – | – | – | ✓ | – |
| `$menuItems` | – | – | – | – | ✓ |
| `$buildMenuLink` | – | – | – | – | ✓ |

### Entity Methods

| Method | Returns | Notes |
|--------|---------|-------|
| `get('title')` | string | Always present |
| `get('status')` | string | `'published'` or `'draft'` |
| `get('created_at')` | DateTime | Use `->format()` for output |
| `get('content')` | string | Rendered HTML |
| `get('author')` | string\|null | Falls back to `$config->author` |
| `get('description')` | string\|null | For meta tags |
| `get('image')` | string\|null | Filename only |
| `get('tags')` | array\|null | Posts only |
| `get('slug')` | string\|null | Custom slug override |
| `get('template')` | string\|null | Custom template |
| `getSlug()` | string | URL path |
| `getSlug($base)` | string | Full URL |
| `getExcerpt()` | string | Posts only |

