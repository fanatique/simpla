# GitHub Actions Deployment

This guide shows you how to set up automated builds and deployments for your Simpla website using GitHub Actions.

**Prerequisites:**
- A GitHub repository with your Simpla website
- Read [Getting Started](01.getting-started.md) first

---

## Table of Contents

1. [Overview](#overview)
2. [Basic Build Workflow](#basic-build-workflow)
3. [Deployment Options](#deployment-options)
4. [Environment-Specific Configurations](#environment-specific-configurations)
5. [Complete Examples](#complete-examples)
6. [Troubleshooting](#troubleshooting)

---

## Overview

### How It Works

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Push to Git   â”‚ â”€â”€â–º â”‚  GitHub Actions  â”‚ â”€â”€â–º â”‚   Deploy Site   â”‚
â”‚                 â”‚     â”‚                  â”‚     â”‚                 â”‚
â”‚ â€¢ Edit content  â”‚     â”‚ â€¢ Build w/Docker â”‚     â”‚ â€¢ FTP/SFTP      â”‚
â”‚ â€¢ Push to main  â”‚     â”‚ â€¢ Generate HTML  â”‚     â”‚ â€¢ GitHub Pages  â”‚
â”‚                 â”‚     â”‚ â€¢ Run tests      â”‚     â”‚ â€¢ Netlify       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Repository Structure

```
your-website/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ deploy.yml        # GitHub Actions workflow
â”œâ”€â”€ page/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ config.php        # Production config
â”‚   â”‚   â””â”€â”€ preview-config.php # Optional: staging config
â”‚   â”œâ”€â”€ content/
â”‚   â””â”€â”€ views/
â””â”€â”€ dist/                     # Generated (can be gitignored)
```

---

## Basic Build Workflow

Create `.github/workflows/deploy.yml`:

```yaml
name: Build and Deploy

on:
  # Run on pushes to main branch
  push:
    branches: [main]

  # Allow manual trigger from Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Check out your repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Create a fresh dist folder
      - name: Prepare dist folder
        run: |
          rm -rf dist
          mkdir dist

      # 3. Build the site using Simpla Docker image
      - name: Build site
        uses: addnab/docker-run-action@v3
        with:
          image: fanatique/simpla:latest
          options: |
            -v ${{ github.workspace }}/page:/usr/src/simpla/page
            -v ${{ github.workspace }}/dist:/usr/src/simpla/dist
          run: composer build

      # 4. Upload dist as artifact (for inspection/download)
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: website
          path: dist/
          retention-days: 7
```

This workflow:
1. Triggers on every push to `main` (or manually)
2. Builds your site using the Simpla Docker image
3. Uploads the generated files as a downloadable artifact

---

## Deployment Options

### Option A: GitHub Pages

Deploy to GitHub Pages for free hosting:

```yaml
name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

# Required for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Only one deployment at a time
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare dist folder
        run: |
          rm -rf dist
          mkdir dist

      - name: Build site
        uses: addnab/docker-run-action@v3
        with:
          image: fanatique/simpla:latest
          options: |
            -v ${{ github.workspace }}/page:/usr/src/simpla/page
            -v ${{ github.workspace }}/dist:/usr/src/simpla/dist
          run: composer build

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
```

**Setup:**
1. Go to your repo â†’ Settings â†’ Pages
2. Set Source to "GitHub Actions"
3. Update `base_url` in your config to match your GitHub Pages URL

### Option B: FTP/SFTP Deployment

Deploy to traditional web hosting via FTP:

```yaml
name: Deploy via FTP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare dist folder
        run: |
          rm -rf dist
          mkdir dist

      - name: Build site
        uses: addnab/docker-run-action@v3
        with:
          image: fanatique/simpla:latest
          options: |
            -v ${{ github.workspace }}/page:/usr/src/simpla/page
            -v ${{ github.workspace }}/dist:/usr/src/simpla/dist
          run: composer build

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          port: 21
          local-dir: ./dist/
          server-dir: ./public_html/  # Adjust to your server's webroot
```

**Setup Secrets:**
1. Go to your repo â†’ Settings â†’ Secrets and variables â†’ Actions
2. Add these secrets:
   - `FTP_SERVER` â€“ Your FTP server address (e.g., `ftp.example.com`)
   - `FTP_USERNAME` â€“ FTP username
   - `FTP_PASSWORD` â€“ FTP password

### Option C: SFTP Deployment

For SSH/SFTP deployments:

```yaml
- name: Deploy via SFTP
  uses: wlixcc/SFTP-Deploy-Action@v1.2.4
  with:
    server: ${{ secrets.SFTP_SERVER }}
    username: ${{ secrets.SFTP_USERNAME }}
    ssh_private_key: ${{ secrets.SFTP_PRIVATE_KEY }}
    local_path: ./dist/*
    remote_path: /var/www/html/
```

### Option D: Netlify

Deploy to Netlify:

```yaml
- name: Deploy to Netlify
  uses: nwtgck/actions-netlify@v2.1
  with:
    publish-dir: ./dist
    production-deploy: true
  env:
    NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
    NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
```

### Option E: Cloudflare Pages

Deploy to Cloudflare Pages:

```yaml
- name: Deploy to Cloudflare Pages
  uses: cloudflare/pages-action@v1
  with:
    apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    projectName: your-project-name
    directory: dist
```

---

## Environment-Specific Configurations

### Multiple Config Files

Create environment-specific configs:

```
page/config/
â”œâ”€â”€ config.php           # Default (production)
â”œâ”€â”€ preview-config.php   # Staging/preview
â””â”€â”€ local-config.php     # Local development (gitignored)
```

**Production config:**
```php
<?php
return json_decode(json_encode([
    "base_url" => "https://www.yoursite.com",
    "theme" => "default",
    // ... other settings
]));
```

**Preview config:**
```php
<?php
return json_decode(json_encode([
    "base_url" => "https://preview.yoursite.com",
    "theme" => "default",
    // ... other settings
]));
```

### Workflow with Config Swap

```yaml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare dist folder
        run: |
          rm -rf dist
          mkdir dist

      # Swap config for production
      - name: Use production config
        run: |
          cp page/config/production-config.php page/config/config.php

      - name: Build site
        uses: addnab/docker-run-action@v3
        with:
          image: fanatique/simpla:latest
          options: |
            -v ${{ github.workspace }}/page:/usr/src/simpla/page
            -v ${{ github.workspace }}/dist:/usr/src/simpla/dist
          run: composer build

      # ... deployment steps
```

### Preview Deployments for Pull Requests

Deploy previews for pull requests:

```yaml
name: Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare
        run: |
          rm -rf dist && mkdir dist

      - name: Use preview config
        run: |
          cp page/config/preview-config.php page/config/config.php

      - name: Build
        uses: addnab/docker-run-action@v3
        with:
          image: fanatique/simpla:latest
          options: |
            -v ${{ github.workspace }}/page:/usr/src/simpla/page
            -v ${{ github.workspace }}/dist:/usr/src/simpla/dist
          run: composer build

      - name: Deploy Preview to Netlify
        uses: nwtgck/actions-netlify@v2.1
        with:
          publish-dir: ./dist
          production-deploy: false
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Preview for PR #${{ github.event.number }}"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
```

---

## Complete Examples

### Full Production Workflow (FTP)

```yaml
name: Build and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  CI: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare build
        run: |
          rm -rf ${{ github.workspace }}/dist
          mkdir ${{ github.workspace }}/dist

      - name: Use production config
        run: |
          if [ -f "${{ github.workspace }}/page/config/production-config.php" ]; then
            cp ${{ github.workspace }}/page/config/production-config.php \
               ${{ github.workspace }}/page/config/config.php
          fi

      - name: Build website
        uses: addnab/docker-run-action@v3
        with:
          image: fanatique/simpla:latest
          options: |
            -v ${{ github.workspace }}/page:/usr/src/simpla/page
            -v ${{ github.workspace }}/dist:/usr/src/simpla/dist
          run: composer build

      - name: List generated files
        run: ls -la ${{ github.workspace }}/dist

      - name: Deploy to server
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          port: 21
          local-dir: ./dist/
          server-dir: ./
```

### Multi-Environment Workflow

```yaml
name: Multi-Environment Deploy

on:
  push:
    branches:
      - main        # Deploy to production
      - develop     # Deploy to staging
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "env=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "env=production" >> $GITHUB_OUTPUT
          else
            echo "env=staging" >> $GITHUB_OUTPUT
          fi

      - name: Prepare
        run: |
          rm -rf dist && mkdir dist

      - name: Set config for ${{ steps.env.outputs.env }}
        run: |
          CONFIG_FILE="page/config/${{ steps.env.outputs.env }}-config.php"
          if [ -f "$CONFIG_FILE" ]; then
            cp "$CONFIG_FILE" page/config/config.php
            echo "Using config: $CONFIG_FILE"
          else
            echo "Using default config"
          fi

      - name: Build
        uses: addnab/docker-run-action@v3
        with:
          image: fanatique/simpla:latest
          options: |
            -v ${{ github.workspace }}/page:/usr/src/simpla/page
            -v ${{ github.workspace }}/dist:/usr/src/simpla/dist
          run: composer build

      - name: Deploy to Production
        if: steps.env.outputs.env == 'production'
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.PROD_FTP_SERVER }}
          username: ${{ secrets.PROD_FTP_USERNAME }}
          password: ${{ secrets.PROD_FTP_PASSWORD }}
          local-dir: ./dist/

      - name: Deploy to Staging
        if: steps.env.outputs.env == 'staging'
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.STAGING_FTP_SERVER }}
          username: ${{ secrets.STAGING_FTP_USERNAME }}
          password: ${{ secrets.STAGING_FTP_PASSWORD }}
          local-dir: ./dist/
```

---

## Troubleshooting

### Build Fails: "Cannot find config.php"

**Cause:** The config file path is incorrect.

**Fix:** Ensure `page/config/config.php` exists and is committed to git.

### Empty dist Folder

**Cause:** Volume mounting issues.

**Fix:** Check that paths in the Docker options are correct:
```yaml
options: |
  -v ${{ github.workspace }}/page:/usr/src/simpla/page
  -v ${{ github.workspace }}/dist:/usr/src/simpla/dist
```

### FTP Deployment Fails

**Cause:** Usually authentication or path issues.

**Fix:**
1. Verify secrets are set correctly in repo settings
2. Check `server-dir` matches your hosting provider's webroot
3. Try with `protocol: ftp` if `ftps` doesn't work

### "Permission Denied" Errors

**Cause:** File permission issues in the runner.

**Fix:** Add a permissions fix step:
```yaml
- name: Fix permissions
  run: chmod -R 755 dist/
```

### Docker Image Not Found

**Cause:** Docker Hub rate limiting or network issues.

**Fix:** Add retry logic or use GitHub Container Registry:
```yaml
- name: Pull Simpla image
  run: docker pull fanatique/simpla:latest
  continue-on-error: true
```

### Caching for Faster Builds

Add caching to speed up repeated builds:

```yaml
- name: Cache Docker image
  uses: actions/cache@v4
  with:
    path: /tmp/simpla-image.tar
    key: simpla-image-${{ hashFiles('**/config.php') }}

- name: Load cached image
  run: |
    if [ -f /tmp/simpla-image.tar ]; then
      docker load < /tmp/simpla-image.tar
    else
      docker pull fanatique/simpla:latest
      docker save fanatique/simpla:latest > /tmp/simpla-image.tar
    fi
```

---

## Tips

### Status Badge

Add a build status badge to your README:

```markdown
![Build Status](https://github.com/USERNAME/REPO/actions/workflows/deploy.yml/badge.svg)
```

### Scheduled Builds

Rebuild your site on a schedule (e.g., for dynamic content):

```yaml
on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
```

### Notifications

Get notified on deployment:

```yaml
- name: Notify on Slack
  if: success()
  uses: slackapi/slack-github-action@v1.24.0
  with:
    payload: |
      {
        "text": "âœ… Website deployed successfully!"
      }
  env:
    SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
```

---

## Next Steps

ğŸ“– **Learn More:**
- [Creating Content](03.creating-content.md)
- [Customizing Templates](02.setting-up-a-customized-page.md)

ğŸ”— **Resources:**
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [FTP Deploy Action](https://github.com/SamKirkland/FTP-Deploy-Action)
- [GitHub Pages](https://pages.github.com/)

